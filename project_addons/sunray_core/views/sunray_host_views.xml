<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- List View -->
    <record id="sunray_host__listview" model="ir.ui.view">
        <field name="name">sunray.host.list</field>
        <field name="model">sunray.host</field>
        <field name="arch" type="xml">
            <list>
                <field name="domain"/>
                <field name="sunray_worker_id" string="Worker" optional="show"/>
                <field name="pending_worker_name" string="Pending Worker" optional="show"/>
                <field name="migration_pending_duration" string="Migration Pending" optional="show"/>
                <field name="backend_url" optional="show"/>
                <field name="block_all_traffic" string="Block all traffic" widget="boolean_toggle"/>
                <field name="last_migration_ts" string="Last Migration" optional="show"/>
                <field name="create_date" optional="show"/>
                <field name="config_version" optional="show"/>
            </list>
        </field>
    </record>
    
    <!-- Search View -->
    <record id="view_sunray_host_search" model="ir.ui.view">
        <field name="name">sunray.host.search</field>
        <field name="model">sunray.host</field>
        <field name="arch" type="xml">
            <search>
                <field name="domain"/>
                <field name="backend_url"/>
                <field name="sunray_worker_id"/>
                <field name="pending_worker_name"/>
                <separator/>
                <filter name="traffic_blocked" string="Traffic blocked" domain="[('block_all_traffic', '=', True)]"/>
                <filter name="traffic_not_blocked" string="Traffic not blocked" domain="[('block_all_traffic', '=', False)]"/>
                <filter name="bound" string="Worker Bound" domain="[('sunray_worker_id', '!=', False)]"/>
                <filter name="unbound" string="Unbound" domain="[('sunray_worker_id', '=', False)]"/>
                <filter name="pending_migration" string="Pending Migration" domain="[('pending_worker_name', '!=', False)]"/>
                <group expand="0" string="Group By">
                    <!-- <filter string="Status" name="group_by_status" context="{'group_by': 'is_active'}"/> -->
                    <filter string="Worker" name="group_by_worker" context="{'group_by': 'sunray_worker_id'}"/>
                    <filter string="Migration Status" name="group_by_migration" context="{'group_by': 'pending_worker_name'}"/>
                </group>
            </search>
        </field>
    </record>
    
    <!-- Form View -->
    <record id="view_sunray_host_form" model="ir.ui.view">
        <field name="name">sunray.host.form</field>
        <field name="model">sunray.host</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="%(action_sunray_setup_token_wizard)d" string="Generate Setup Token" icon="fa-key" type="action" class="btn-warning"
                            context="{'default_host_id': id}"
                            help="Generate a new setup token for a user to register their device for this host"/>
                    <button name="force_cache_refresh" string="Force Config Refresh" icon="fa-refresh" type="object" class="btn-warning"
                            help="Forces the worker to immediately refresh its cached configuration for this host. Use this after making changes to access rules, webhook tokens, or other host settings that need to take effect immediately. This does not affect user sessions - users remain logged in."
                            confirm="This will immediately invalidate cached configuration for this host. Continue?"/>
                    <button name="action_clear_all_sessions" string="Clear All Sessions" icon="fa-user-times" type="object" class="btn-danger"
                            help="Removes all active user sessions for this protected host. All users will need to re-authenticate to access this host. This is useful when you need to force all users to re-login, such as after a security policy change. Note: This does not affect the configuration cache."
                            confirm="This will immediately terminate all active user sessions for this host. All users will need to re-authenticate. Continue?"/>
                    <button name="action_clear_pending_migration" string="Clear Pending Migration" icon="fa-times" type="object" class="btn-secondary"
                            invisible="not pending_worker_name"
                            confirm="This will cancel the pending worker migration. Continue?"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button"
                                type="object"
                                string="Refresh"
                                icon="fa-refresh"
                                name="btn_refresh" />
                    </div>
                    <group>
                        <group>
                            <field name="domain"/>
                            <field name="sunray_worker_id" readonly="1" help="Worker is automatically assigned when it first contacts the server"/>
                            <field name="backend_url" widget="url"/>
                        </group>
                        <group>
                            <field name="block_all_traffic" widget="boolean_toggle"/>
                            <field name="create_date" readonly="1"/>
                            <field name="config_version" readonly="1"/>
                        </group>
                    </group>
                    
                    <!-- Traffic Blocking Warning -->
                    <group string="Protection Status" invisible="not block_all_traffic" name="protection_status">
                        <div class="alert alert-danger" role="alert">
                            <strong>⚠️ All traffic blocked:</strong> This host is currently blocking all traffic with 503 Service Unavailable.
                            <br/>To allow access:
                            <ul class="mb-0 mt-2">
                                <li>Uncheck "Block All Traffic" to restore normal authentication</li>
                            </ul>
                        </div>
                    </group>
                    
                    <group string="Worker Migration" invisible="not pending_worker_name">
                        <div class="alert alert-warning" role="alert">
                            <strong>Migration Pending:</strong> This host will migrate to worker 
                            <field name="pending_worker_name" readonly="1" nolabel="1" style="display:inline;"/> 
                            when it registers.
                        </div>
                        <group>
                            <field name="migration_requested_at" readonly="1"/>
                            <field name="migration_pending_duration" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Worker Migration Control">
                        <field name="pending_worker_name" placeholder="Enter worker ID to migrate to"/>
                        <field name="last_migration_ts" readonly="1" invisible="not last_migration_ts"/>
                    </group>
                    
                    <notebook>
                        <page string="Access Rules">
                            <div class="alert alert-success" role="status">
                                <p class="mb-0">
                                    <strong>Default Protection:</strong> In the absence of access rules, passkey-based authentication protection applies to all requests.
                                    Access rules below define exceptions to this default behavior.
                                </p>
                            </div>

                            <div class="alert alert-info" role="status">
                                <h3>Reusable Access Rule Library</h3>
                                <p>
                                    Select rules from the library and set their priority for this host.
                                    The same rule can be used on multiple hosts with different priorities.
                                </p>
                                <p><strong>How to manage rules:</strong></p>
                                <ul>
                                    <li><strong>Select Rule:</strong> Choose from active rules in the library</li>
                                    <li><strong>Set Priority:</strong> Lower number = higher priority (use drag-and-drop or edit manually)</li>
                                    <li><strong>Active Toggle:</strong> Enable/disable rule on this specific host</li>
                                    <li><strong>Create New Rules:</strong> Navigate to <strong>Sunray → Access Rule Library</strong></li>
                                </ul>
                            </div>

                            <field name="access_rule_rel_ids" nolabel="1">
                                <list editable="bottom">
                                    <!-- Drag-and-drop handle for priority reordering -->
                                    <field name="priority" widget="handle"/>

                                    <!-- Rule selector (only active library rules) -->
                                    <field name="rule_id"
                                           options="{'no_create': True}"
                                           domain="[('is_active', '=', True)]"/>

                                    <!-- Display rule type (read-only) -->
                                    <field name="rule_type" widget="badge" readonly="1"
                                           decoration-success="rule_type == 'public'"
                                           decoration-info="rule_type == 'cidr'"
                                           decoration-warning="rule_type == 'token'"/>

                                    <!-- Per-host active toggle -->
                                    <field name="is_active" widget="boolean_toggle"/>

                                    <!-- Quick view button -->
                                    <button name="action_view_rule" type="object"
                                            icon="fa-external-link"
                                            title="View Rule Details"
                                            class="btn-link"/>
                                </list>
                            </field>

                            <div class="alert alert-success mt16" role="status">
                                <p class="mb-0">
                                    <strong>Tip:</strong> Drag rows to reorder priorities. Changes to rules in the library
                                    automatically affect all hosts using them. Priority and active status are per-host.
                                </p>
                            </div>
                        </page>
                                                
                        <page string="Authorized Users">
                            <field name="user_stat_ids" nolabel="1" readonly="1">
                                <list>
                                    <field name="username"/>
                                    <field name="email" optional="show"/>
                                    <field name="is_active" widget="boolean_toggle"/>
                                    <field name="passkey_count" string="Passkeys"/>
                                    <field name="setup_token_count" string="Setup Tokens"/>
                                    <field name="active_session_count" string="Active Sessions"/>
                                    <field name="last_login" optional="show"/>
                                    <button name="btn_remove_user" string="Remove User" type="object"
                                        icon="fa-trash" class="btn-danger"
                                        confirm="This will remove the user from this host and delete all their passkeys, setup tokens, and sessions for this host. Continue?"
                                        help="Remove user from this host and delete all host-specific credentials"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Active Sessions">
                            <div class="mb16">
                                <h3>Active User Sessions</h3>
                                <p>Currently active user sessions on this host. Sessions shown here are properly filtered to display only active sessions.</p>
                                <p><strong>Active Sessions: <field name="active_session_count" readonly="1" nolabel="1" style="display:inline;"/></strong></p>
                            </div>
                            <field name="active_session_ids" readonly="0">
                                <list>
                                    <field name="session_id"/>
                                    <field name="user_id"/>
                                    <field name="created_at"/>
                                    <field name="last_activity"/>
                                    <field name="expires_at"/>
                                    <field name="created_ip" optional="show"/>
                                    <field name="last_ip" optional="show"/>
                                    <field name="is_active" widget="boolean_toggle" readonly="1"/>
                                </list>
                                <form>
                                    <sheet>
                                        <group>
                                            <group>
                                                <field name="session_id" readonly="1"/>
                                                <field name="user_id" readonly="1"/>
                                                <field name="is_active" readonly="1"/>
                                            </group>
                                            <group>
                                                <field name="created_at" readonly="1"/>
                                                <field name="last_activity" readonly="1"/>
                                                <field name="expires_at" readonly="1"/>
                                            </group>
                                        </group>
                                        <group string="Security Information">
                                            <field name="created_ip" readonly="1"/>
                                            <field name="last_ip" readonly="1"/>
                                            <field name="user_agent" readonly="1"/>
                                            <field name="device_fingerprint" readonly="1"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>
                        
                        <page string="API &amp; Webhook Tokens">
                            <div class="alert alert-info" role="status">
                                <h3>Token Management via Access Rules</h3>
                                <p>
                                    Webhook tokens are now managed globally and can be reused across multiple hosts.
                                    This allows the same token (e.g., a Shopify webhook token) to authenticate to multiple protected hosts.
                                </p>
                                <p><strong>How to use tokens with this host:</strong></p>
                                <ol>
                                    <li>Navigate to <strong>Sunray → Webhook Tokens</strong> menu to create or view global tokens</li>
                                    <li>Create an <strong>Access Rule</strong> (see "Access Rules" tab above) with type "Token Access"</li>
                                    <li>In the Access Rule, specify URL patterns and select one or more tokens</li>
                                    <li>The selected tokens will be able to authenticate requests matching those URL patterns</li>
                                </ol>
                                <p class="mb-0">
                                    <strong>Benefits:</strong> Token reuse, centralized management, flexible URL pattern mapping.
                                </p>
                            </div>

                            <div class="mt16">
                                <h3>Examples for Common Providers:</h3>
                                <p><strong>Shopify Webhooks:</strong> Header = X-Shopify-Hmac-Sha256, Source = Header Only</p>
                                <p><strong>Stripe Webhooks:</strong> Header = Stripe-Signature, Source = Header Only</p>
                                <p><strong>GitHub Webhooks:</strong> Header = X-Hub-Signature-256, Source = Header Only</p>
                                <p><strong>Generic APIs:</strong> Parameter = api_key, Source = Parameter Only</p>
                            </div>
                        </page>

                        <page string="Configuration" name="page_configuration">
                            <group string="Session Settings">
                                <field name="session_duration_s"/>
                            </group>
                            
                            <group string="WebSocket Configuration">
                                <field name="websocket_url_prefix" placeholder="/ws/"/>
                            </group>
                            
                            <group string="WAF Integration" name="waf_integration_group">
                                <group>
                                    <field name="bypass_waf_for_authenticated"/>
                                </group>
                                <group>
                                    <field name="waf_bypass_revalidation_s" invisible="not bypass_waf_for_authenticated"/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="Helpers">
                            <div class="alert alert-info" role="alert">
                                <p><strong>API Testing Commands</strong></p>
                                <p>Use these curl commands to check Sunray Server API connectivity. Adjust the endpoint path as needed for different API calls.</p>
                                <p>Note: If server URL shows "YOUR_SERVER_URL", set the system parameter 'web.base.url' in Settings → Technical → Parameters.</p>
                            </div>
                            
                            <group string="Server API Test">
                                <field name="server_curl_helper" 
                                       widget="CopyClipboardChar" 
                                       nolabel="1"
                                       readonly="1"
                                       style="font-family: monospace; background-color: #f5f5f5; padding: 10px;"/>
                            </group>
                            
                            <group string="Worker Status Test">
                                <field name="worker_curl_helper" 
                                       widget="CopyClipboardChar"
                                       nolabel="1" 
                                       readonly="1"
                                       style="font-family: monospace; background-color: #f5f5f5; padding: 10px;"/>
                            </group>
                        </page>
                        
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Action -->
    <record id="action_sunray_hosts" model="ir.actions.act_window">
        <field name="name">Protected Hosts</field>
        <field name="res_model">sunray.host</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_sunray_host_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Configure your first protected host
            </p>
            <p>
                Protected hosts are domains that require authentication via Sunray.
                Configure access control rules and authorized users for each host.
            </p>
        </field>
    </record>
</odoo>