<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- List View -->
    <record id="view_sunray_host_tree" model="ir.ui.view">
        <field name="name">sunray.host.list</field>
        <field name="model">sunray.host</field>
        <field name="arch" type="xml">
            <list>
                <field name="domain"/>
                <field name="sunray_worker_id" string="Worker" optional="show"/>
                <field name="pending_worker_name" string="Pending Worker" optional="show"/>
                <field name="migration_pending_duration" string="Migration Pending" optional="show"/>
                <field name="backend_url" optional="show"/>
                <field name="is_active" widget="boolean_toggle"/>
                <field name="last_migration_ts" string="Last Migration" optional="show"/>
                <field name="create_date" optional="show"/>
                <field name="config_version" optional="show"/>
            </list>
        </field>
    </record>
    
    <!-- Search View -->
    <record id="view_sunray_host_search" model="ir.ui.view">
        <field name="name">sunray.host.search</field>
        <field name="model">sunray.host</field>
        <field name="arch" type="xml">
            <search>
                <field name="domain"/>
                <field name="backend_url"/>
                <field name="sunray_worker_id"/>
                <field name="pending_worker_name"/>
                <separator/>
                <filter name="active" string="Active" domain="[('is_active', '=', True)]"/>
                <filter name="inactive" string="Inactive" domain="[('is_active', '=', False)]"/>
                <filter name="bound" string="Worker Bound" domain="[('sunray_worker_id', '!=', False)]"/>
                <filter name="unbound" string="Unbound" domain="[('sunray_worker_id', '=', False)]"/>
                <filter name="pending_migration" string="Pending Migration" domain="[('pending_worker_name', '!=', False)]"/>
                <group expand="0" string="Group By">
                    <filter string="Status" name="group_by_status" context="{'group_by': 'is_active'}"/>
                    <filter string="Worker" name="group_by_worker" context="{'group_by': 'sunray_worker_id'}"/>
                    <filter string="Migration Status" name="group_by_migration" context="{'group_by': 'pending_worker_name'}"/>
                </group>
            </search>
        </field>
    </record>
    
    <!-- Form View -->
    <record id="view_sunray_host_form" model="ir.ui.view">
        <field name="name">sunray.host.form</field>
        <field name="model">sunray.host</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="force_cache_refresh" string="Force Config Refresh" icon="fa-refresh" type="object" class="btn-warning"
                            help="Forces the worker to immediately refresh its cached configuration for this host. Use this after making changes to access rules, webhook tokens, or other host settings that need to take effect immediately. This does not affect user sessions - users remain logged in."
                            confirm="This will immediately invalidate cached configuration for this host. Continue?"/>
                    <button name="action_clear_all_sessions" string="Clear All Sessions" icon="fa-user-times" type="object" class="btn-danger"
                            help="Removes all active user sessions for this protected host. All users will need to re-authenticate to access this host. This is useful when you need to force all users to re-login, such as after a security policy change. Note: This does not affect the configuration cache."
                            confirm="This will immediately terminate all active user sessions for this host. All users will need to re-authenticate. Continue?"/>
                    <button name="action_clear_pending_migration" string="Clear Pending Migration" icon="fa-times" type="object" class="btn-secondary"
                            invisible="not pending_worker_name"
                            confirm="This will cancel the pending worker migration. Continue?"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="domain"/>
                            <field name="sunray_worker_id" readonly="1" help="Worker is automatically assigned when it first contacts the server"/>
                            <field name="backend_url" widget="url"/>
                        </group>
                        <group>
                            <field name="is_active" widget="boolean_toggle"/>
                            <field name="create_date" readonly="1"/>
                            <field name="config_version" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Worker Migration" invisible="not pending_worker_name">
                        <div class="alert alert-warning" role="alert">
                            <strong>Migration Pending:</strong> This host will migrate to worker 
                            <field name="pending_worker_name" readonly="1" nolabel="1" style="display:inline;"/> 
                            when it registers.
                        </div>
                        <group>
                            <field name="migration_requested_at" readonly="1"/>
                            <field name="migration_pending_duration" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Worker Migration Control">
                        <field name="pending_worker_name" placeholder="Enter worker ID to migrate to"/>
                        <field name="last_migration_ts" readonly="1" invisible="not last_migration_ts"/>
                    </group>
                    
                    <notebook>
                        <page string="Access Rules">
                            <field name="access_rule_ids">
                                <list default_order="priority, id">
                                    <field name="priority"/>
                                    <field name="description"/>
                                    <field name="access_type" widget="badge" decoration-success="access_type == 'public'" decoration-info="access_type == 'cidr'" decoration-warning="access_type == 'token'"/>
                                    <field name="is_active" widget="boolean_toggle"/>
                                </list>
                                <form>
                                    <sheet>
                                        <group>
                                            <group>
                                                <field name="description" placeholder="e.g., GitLab Webhook for CI/CD"/>
                                                <field name="priority"/>
                                                <field name="access_type"/>
                                                <field name="is_active"/>
                                            </group>
                                        </group>
                                        
                                        <group string="URL Patterns">
                                            <field name="url_patterns" widget="text" nolabel="1" 
                                                   placeholder="^/api/webhook.*&#10;^/public/.*"/>
                                        </group>
                                        
                                        <group string="CIDR Configuration" invisible="access_type != 'cidr'">
                                            <field name="allowed_cidrs" widget="text" nolabel="1"
                                                   placeholder="192.168.1.0/24&#10;10.0.0.0/8"/>
                                        </group>
                                        
                                        <group string="Token Configuration" invisible="access_type != 'token'">
                                            <field name="token_ids" nolabel="1" 
                                                   context="{'default_host_id': parent.id}"
                                                   domain="[('host_id', '=', parent.id)]">
                                                <list>
                                                    <field name="name"/>
                                                    <field name="token_source"/>
                                                    <field name="is_active" widget="boolean_toggle"/>
                                                </list>
                                            </field>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                            
                            <div class="mt16">
                                <h3>Access Rule Priority</h3>
                                <p>Rules are evaluated in priority order (lower number = higher priority).</p>
                                <p>The first matching rule determines access type. If no rule matches, passkey authentication is required.</p>
                            </div>
                        </page>
                                                
                        <page string="Authorized Users">
                            <field name="user_ids" />
                        </page>
                        
                        <page string="Active Sessions">
                            <div class="mb16">
                                <h3>Active User Sessions</h3>
                                <p>Currently active user sessions on this host. Sessions shown here are properly filtered to display only active sessions.</p>
                                <p><strong>Active Sessions: <field name="active_session_count" readonly="1" nolabel="1" style="display:inline;"/></strong></p>
                            </div>
                            <field name="active_session_ids" readonly="1">
                                <list>
                                    <field name="session_id"/>
                                    <field name="user_id"/>
                                    <field name="created_at"/>
                                    <field name="last_activity"/>
                                    <field name="expires_at"/>
                                    <field name="created_ip" optional="show"/>
                                    <field name="last_ip" optional="show"/>
                                    <field name="is_active" widget="boolean_toggle" readonly="1"/>
                                </list>
                                <form>
                                    <sheet>
                                        <group>
                                            <group>
                                                <field name="session_id" readonly="1"/>
                                                <field name="user_id" readonly="1"/>
                                                <field name="is_active" readonly="1"/>
                                            </group>
                                            <group>
                                                <field name="created_at" readonly="1"/>
                                                <field name="last_activity" readonly="1"/>
                                                <field name="expires_at" readonly="1"/>
                                            </group>
                                        </group>
                                        <group string="Security Information">
                                            <field name="created_ip" readonly="1"/>
                                            <field name="last_ip" readonly="1"/>
                                            <field name="user_agent" readonly="1"/>
                                            <field name="device_fingerprint" readonly="1"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>
                        
                        <page string="API &amp; Webhook Tokens">
                            <field name="webhook_token_ids">
                                <list>
                                    <field name="name"/>
                                    <field name="token_source"/>
                                    <field name="header_name" optional="show"/>
                                    <field name="param_name" optional="show"/>
                                    <field name="is_active" widget="boolean_toggle"/>
                                    <field name="expires_at" optional="show"/>
                                    <field name="last_used" optional="show"/>
                                    <field name="usage_count" optional="show"/>
                                </list>
                                <form>
                                    <sheet>
                                        <group>
                                            <group name="basic_info">
                                                <field name="name"/>
                                                <field name="token" password="True"/>
                                                <field name="is_active"/>
                                            </group>
                                            <group name="extraction_config">
                                                <field name="token_source"/>
                                                <field name="header_name" 
                                                       invisible="token_source == 'param'"
                                                       required="token_source in ('header', 'both')"/>
                                                <field name="param_name" 
                                                       invisible="token_source == 'header'"
                                                       required="token_source in ('param', 'both')"/>
                                            </group>
                                        </group>
                                        
                                        <group string="Access Restrictions">
                                            <field name="allowed_cidrs" 
                                                   placeholder="192.168.1.0/24&#10;10.0.0.0/8&#10;# Comments supported"/>
                                            <field name="expires_at"/>
                                        </group>
                                        
                                        <group string="Usage Statistics">
                                            <field name="usage_count" readonly="1"/>
                                            <field name="last_used" readonly="1"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                            
                            <div class="mt16">
                                <h3>Examples for Common Providers:</h3>
                                <p><strong>Shopify Webhooks:</strong> Header = X-Shopify-Hmac-Sha256, Source = Header Only</p>
                                <p><strong>Stripe Webhooks:</strong> Header = Stripe-Signature, Source = Header Only</p>
                                <p><strong>GitHub Webhooks:</strong> Header = X-Hub-Signature-256, Source = Header Only</p>
                                <p><strong>Generic APIs:</strong> Parameter = api_key, Source = Parameter Only</p>
                                <p><strong>Note:</strong> Create tokens here, then reference them in Access Rules to define which URLs they can access.</p>
                            </div>
                        </page>

                        <page string="Configuration">
                            <group string="Session Settings">
                                <field name="session_duration_s"/>
                            </group>
                            
                            <group string="WAF Integration">
                                <field name="bypass_waf_for_authenticated"/>
                                <field name="waf_bypass_revalidation_s" invisible="not bypass_waf_for_authenticated"/>
                            </group>
                            
                        </page>
                        
                        <page string="Helpers">
                            <div class="alert alert-info" role="alert">
                                <p><strong>API Testing Commands</strong></p>
                                <p>Use these curl commands to check Sunray Server API connectivity. Adjust the endpoint path as needed for different API calls.</p>
                                <p>Note: If server URL shows "YOUR_SERVER_URL", set the system parameter 'web.base.url' in Settings → Technical → Parameters.</p>
                            </div>
                            
                            <group string="Server API Test">
                                <field name="server_curl_helper" 
                                       widget="CopyClipboardChar" 
                                       nolabel="1"
                                       readonly="1"
                                       style="font-family: monospace; background-color: #f5f5f5; padding: 10px;"/>
                            </group>
                            
                            <group string="Worker Status Test">
                                <field name="worker_curl_helper" 
                                       widget="CopyClipboardChar"
                                       nolabel="1" 
                                       readonly="1"
                                       style="font-family: monospace; background-color: #f5f5f5; padding: 10px;"/>
                            </group>
                        </page>
                        
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>
    
    <!-- Action -->
    <record id="action_sunray_hosts" model="ir.actions.act_window">
        <field name="name">Protected Hosts</field>
        <field name="res_model">sunray.host</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_sunray_host_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Configure your first protected host
            </p>
            <p>
                Protected hosts are domains that require authentication via Sunray.
                Configure access control rules and authorized users for each host.
            </p>
        </field>
    </record>
</odoo>